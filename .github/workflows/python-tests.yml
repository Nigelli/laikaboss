name: Python Tests

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # Fast lint check - runs first to catch obvious issues
  lint:
    name: Lint Check
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort

    - name: Run critical flake8 checks
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
          --exclude=dependencies/,build/,*.egg-info/

    - name: Check code formatting (non-blocking)
      continue-on-error: true
      run: |
        black --check --diff laikaboss/ --exclude=dependencies/

    - name: Check import sorting (non-blocking)
      continue-on-error: true
      run: |
        isort --check-only --diff laikaboss/

  # Unit tests - fast tests without external dependencies
  unit-tests:
    name: Unit Tests - Python ${{ matrix.python-version }}
    needs: lint
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          python3-dev \
          libldap2-dev \
          libsasl2-dev \
          libyara-dev \
          libfuzzy-dev \
          libmagic1 \
          libxml2-dev \
          libxslt1-dev \
          zlib1g-dev \
          liblzma-dev \
          libsnappy-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pytest pytest-cov pytest-timeout
        # Install project requirements
        pip install -r requirements3.txt || {
          echo "::warning::Some requirements failed to install"
          # Install what we can for basic testing
          pip install yara-python pyclamd oletools lxml pillow
        }
        # Install laikaboss in development mode
        pip install -e . || echo "::warning::Package install failed"

    - name: Run unit tests
      run: |
        pytest tests/unit/ -v \
          --timeout=60 \
          --cov=laikaboss \
          --cov-report=xml \
          --cov-report=term \
          -m "unit or not integration" \
          || echo "::warning::Some unit tests failed"
      continue-on-error: true

    - name: Upload coverage reports
      if: matrix.python-version == '3.10'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unit
        name: unit-py${{ matrix.python-version }}
        fail_ci_if_error: false

  # Integration tests - includes legacy .lbtest files
  integration-tests:
    name: Integration Tests
    needs: unit-tests
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          python3-dev \
          libldap2-dev \
          libsasl2-dev \
          libyara-dev \
          libfuzzy-dev \
          libmagic1 \
          libxml2-dev \
          libxslt1-dev \
          zlib1g-dev \
          liblzma-dev \
          libsnappy-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pytest pytest-cov pytest-timeout
        pip install -r requirements3.txt || echo "::warning::Some requirements failed"
        pip install -e . || echo "::warning::Package install failed"

    - name: Run integration tests
      run: |
        pytest tests/integration/ -v \
          --timeout=300 \
          --cov=laikaboss \
          --cov-report=xml \
          --cov-report=term \
          -m "integration or module" \
          || echo "::warning::Some integration tests failed"
      continue-on-error: true

    - name: Run legacy laikatest framework
      run: |
        if [ -f "laikatest.py" ]; then
          python laikatest.py tests/ || echo "::warning::Some legacy tests failed"
        fi
      continue-on-error: true

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: integration
        name: integration
        fail_ci_if_error: false

    - name: Archive test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-integration
        path: |
          coverage.xml
          .coverage
        retention-days: 30

  # Security scan
  security:
    name: Security Scan
    needs: lint
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install bandit
      run: pip install bandit

    - name: Run security checks
      run: |
        bandit -r laikaboss/ -f json -o bandit-report.json || true
        bandit -r laikaboss/ -f txt || echo "Security issues found (review bandit-report.json)"
      continue-on-error: true

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: bandit-report.json
        retention-days: 30
